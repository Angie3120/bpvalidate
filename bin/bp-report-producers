#!/usr/bin/perl -w

use utf8;
use strict;
use EOSN::Report;
use HTML::Entities;
use List::Util qw(shuffle);

binmode(STDOUT, ":utf8");

my %sev;
$sev{skip} = 6;
$sev{crit} = 5;
$sev{err} = 4;
$sev{warn} = 3;
$sev{info} = 2;
$sev{ok} = 1;

# ---------------------------------------------------------------------------
# Main

my $data = get_report_options ();
my @report;

foreach my $entry (@{$$data{producers}}) {
	my @section;

	my $producer = $$entry{regproducer}{owner};
	my $producer_name_html = encode_entities($$entry{info}{name} || $$entry{regproducer}{owner});
	foreach my $message (@{$$entry{messages}}) {
		push (@section, ["%4s, %11s, %s\n", $$message{kind}, $$message{class}, generate_message($message)]);
	}

	generate_report (data => $data, report => [{rows => \@section}], title => "Report for $producer_name_html", columns => 1, icons => 1, class => 2, outfile => "producers/$producer", text => 1, html => 1);
}

push (@report, "<div>\n");
foreach my $entry (shuffle (@{$$data{producers}})) {
	my $producer = $$entry{regproducer}{owner};
	my $rank = $$entry{info}{rank};
	my $votep = $$entry{info}{vote_percent};
	my $producer_name_html = encode_entities($$entry{info}{name} || $$entry{regproducer}{owner});
	my $country = $$entry{info}{country_alpha2};

	my $logo = $$entry{output}{resources}{social_logo_256}[0]{address} || '';
	$logo = '' if ($logo !~ m#https://#);
	if ($logo) {
		$logo = "<figure class=\"image is-24x24\"><img src=\"$logo\"></figure>\n";
	} else {
		$logo = "<figure class=\"image is-24x24\"></figure>\n";
	}
	my %results;

	foreach my $message (@{$$entry{messages}}) {
		my $code = $$message{kind};
		my $class = $$message{class};
		my $sev = $results{$class} || 'ok';
		if ($sev{$code} >= $sev{$sev}) {
			$results{$class} = $code;
		}
	}

	foreach my $key (qw (regproducer org endpoint)) {
		my $html = sev_html($results{$key} || 'skip', $key);
		$results{$key} = $html;
	}

	my $selected = '';
	if ($rank <= 21) {
		$selected = sev_html('selected');
	} elsif ($votep > 0.5) {
		$selected = sev_html('standby');
	}

	my $flag = '';
	if ($country) {
		$flag = flag_html($country);
	}

	push (@report, "<div id=\"bp_$producer\" class=\"scorecard\">\n");
	push (@report, "<div>\n");
	push (@report, "  <div style=\"display: inline-block; vertical-align: middle; width: 32px\">$logo</div>\n");
	push (@report, "  <div style=\"display: inline-block; vertical-align: middle; width: 28px\">$flag</div>\n");
	push (@report, "  <div style=\"display: inline-block; vertical-align: middle; width: 32px\">$selected</div>\n");
	push (@report, "  <div style=\"display: inline-block; vertical-align: middle; width: 32px\">$results{regproducer}</div>\n");
	push (@report, "  <div style=\"display: inline-block; vertical-align: middle; width: 32px\">$results{org}</div>\n");
	push (@report, "  <div style=\"display: inline-block; vertical-align: middle; width: 32px\">$results{endpoint}</div>\n");
	push (@report, "</div>\n");
	push (@report, "<div><a href=\"$producer.html\">$producer_name_html</a></div>\n");
	push (@report, "</div>\n");
}
push (@report, "</div>\n");

write_report_thtml (content => \@report, title => 'Producer Scorecard', outfile => "producers/index");
